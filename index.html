<!DOCTYPE html>
<html lang="ru" x-data="watercolorApp">
<head>
    <meta charset="UTF-8">
    <title>Watercolor Flow Therapy - Alpine.js Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/2.0.5/p5.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #f8f5f2; font-family: sans-serif; }
        #ui { 
            position: fixed; top: 20px; left: 20px; z-index: 100;
            display: flex; flex-direction: column; gap: 15px; 
            background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
            border: 1px solid rgba(0,0,0,0.05);
            user-select: none;
        }
        .palette { display: flex; gap: 8px; margin-bottom: 5px; flex-wrap: wrap; }
        .dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; 
               border: 2px solid #ddd; transition: 0.2s; }
        .dot.active { border-color: #333; transform: scale(1.1); }
        .slider-group { display: flex; flex-direction: column; gap: 8px; font-size: 13px; color: #555; }
        input[type=range] { cursor: pointer; width: 150px; }
        button { border: none; background: #5d8aa8; color: white; 
                 padding: 10px 16px; border-radius: 6px; cursor: pointer; 
                 font-weight: 500; transition: 0.2s; }
        button:hover { background: #4a7795; }
        .title { font-size: 14px; font-weight: 600; color: #333; margin-bottom: 5px; }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Ç–µ–∫—É—â–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π */
        .value-display { 
            font-size: 11px; 
            color: #777; 
            display: flex; 
            justify-content: space-between;
            margin-top: 2px;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ö–æ–ª—Å—Ç–∞ */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è */
        .mode-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body x-on:keydown.escape="clearCanvas()" x-effect="updateP5Settings()">
    <div id="ui" x-on:click.stop>
        <div class="title">üé® –ü–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤</div>
        <div class="palette">
            <template x-for="color in colors" :key="color.value">
                <div 
                    class="dot" 
                    :class="{ active: selectedColor === color.value }"
                    :style="`background: ${color.value}`"
                    x-on:click="selectedColor = color.value"
                    :title="color.name"
                ></div>
            </template>
        </div>

        <div class="slider-group">
            <label>–®–∏—Ä–∏–Ω–∞ –∫–∏—Å—Ç–∏: <span x-text="brushSize"></span>px</label>
            <input 
                type="range" 
                x-model="brushSize"
                min="10" 
                max="80" 
                step="1"
                x-on:mousedown.stop
                x-on:click.stop
            >
            <div class="value-display">
                <span>–¢–æ–Ω–∫–∞—è</span>
                <span>–¢–æ–ª—Å—Ç–∞—è</span>
            </div>
        </div>

        <div class="slider-group">
            <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å: <span x-text="transparency"></span>%</label>
            <input 
                type="range" 
                x-model="transparency"
                min="10" 
                max="60" 
                step="1"
                x-on:mousedown.stop
                x-on:click.stop
            >
            <div class="value-display">
                <span>–°–ª–∞–±–∞—è</span>
                <span>–°–∏–ª—å–Ω–∞—è</span>
            </div>
        </div>

        <div class="slider-group">
            <label>–†–∞—Å—Ç–µ–∫–∞–Ω–∏–µ: <span x-text="flow"></span></label>
            <input 
                type="range" 
                x-model="flow"
                min="1" 
                max="10" 
                step="1"
                x-on:mousedown.stop
                x-on:click.stop
            >
            <div class="value-display">
                <span>–°—É—Ö–æ</span>
                <span>–ú–æ–∫—Ä–æ</span>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 5px;">
            <button x-on:click="clearCanvas()">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
            <button x-on:click="toggleWaterMode()" :style="waterMode ? 'background: #a8d5e2' : ''">
                <span x-text="waterMode ? 'üé® –ö—Ä–∞—Å–∫–∞' : 'üí¶ –í–æ–¥–∞'"></span>
            </button>
        </div>
        
        <div style="font-size: 11px; color: #888; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;">
            <div>–ù–∞–∂–º–∏—Ç–µ ESC –¥–ª—è –æ—á–∏—Å—Ç–∫–∏</div>
            <div>–î–≤–∏–≥–∞–π—Ç–µ –º–µ–¥–ª–µ–Ω–Ω–æ –¥–ª—è –ø–ª–∞–≤–Ω—ã—Ö –ª–∏–Ω–∏–π</div>
        </div>
    </div>
    
    <div class="mode-indicator">
        –†–µ–∂–∏–º: <span x-text="waterMode ? '–í–æ–¥–∞ üí¶' : '–ö—Ä–∞—Å–∫–∞ üé®'"></span>
    </div>

    <div id="canvas-container"></div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('watercolorApp', () => ({
                // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                colors: [
                    { name: '–ì–æ–ª—É–±–æ–π', value: '#5d8aa8' },
                    { name: '–†–æ–∑–æ–≤—ã–π', value: '#e3a6a1' },
                    { name: '–ó–µ–ª–µ–Ω—ã–π', value: '#7da67d' },
                    { name: '–ñ–µ–ª—Ç—ã–π', value: '#f4d35e' },
                    { name: '–§–∏–æ–ª–µ—Ç–æ–≤—ã–π', value: '#9a7bc9' },
                    { name: '–ß–µ—Ä–Ω—ã–π', value: '#333' },
                    { name: '–ë–∏—Ä—é–∑–æ–≤—ã–π', value: '#a8d5e2' },
                    { name: '–ö–æ—Ä–∞–ª–ª–æ–≤—ã–π', value: '#ff7e6d' }
                ],
                
                // –†–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                selectedColor: '#5d8aa8',
                brushSize: 25,
                transparency: 30,
                flow: 4,
                waterMode: false,
                
                // p5.js –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                p5Canvas: null,
                isPainting: false,
                lastMouseX: 0,
                lastMouseY: 0,
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                init() {
                    // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Alpine –∏ DOM
                    this.$nextTick(() => {
                        this.setupP5();
                        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
                        document.addEventListener('contextmenu', e => e.preventDefault());
                    });
                },
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ p5.js
                setupP5() {
                    const sketch = (p) => {
                        p.setup = () => {
                            this.p5Canvas = p.createCanvas(window.innerWidth, window.innerHeight);
                            this.p5Canvas.parent('canvas-container');
                            p.background(248, 245, 242);
                            p.noStroke();
                        };

                        p.draw = () => {
                            // –ü–ª–∞–≤–Ω–æ–µ –≤—ã—Å—ã—Ö–∞–Ω–∏–µ
                            if (p.frameCount % 3 === 0) {
                                let img = p.get();
                                p.tint(255, 255, 255, 255);
                                p.background(248, 245, 242, 2);
                                p.image(img, 0, 0);
                            }
                            
                            // –†–∏—Å–æ–≤–∞–Ω–∏–µ
                            if (this.isPainting) {
                                let distance = p.dist(p.mouseX, p.mouseY, this.lastMouseX, this.lastMouseY);
                                
                                if (distance > 1) {
                                    let steps = Math.max(1, Math.floor(distance / 2));
                                    
                                    for (let i = 0; i <= steps; i++) {
                                        let interp = i / steps;
                                        let x = p.lerp(this.lastMouseX, p.mouseX, interp);
                                        let y = p.lerp(this.lastMouseY, p.mouseY, interp);
                                        
                                        if (this.waterMode) {
                                            this.drawWaterStroke(p, x, y);
                                        } else {
                                            this.drawPaintStroke(p, x, y);
                                        }
                                    }
                                    
                                    this.lastMouseX = p.mouseX;
                                    this.lastMouseY = p.mouseY;
                                }
                            }
                        };

                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏
                        p.mousePressed = () => {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞ UI –ª–∏ –∫–ª–∏–∫
                            let ui = document.getElementById('ui');
                            let rect = ui.getBoundingClientRect();
                            
                            if (p.mouseX >= rect.left && p.mouseX <= rect.right &&
                                p.mouseY >= rect.top && p.mouseY <= rect.bottom) {
                                return;
                            }
                            
                            this.isPainting = true;
                            this.lastMouseX = p.mouseX;
                            this.lastMouseY = p.mouseY;
                            
                            // –ù–∞—á–∞–ª–æ –º–∞–∑–∫–∞
                            if (this.waterMode) {
                                this.drawWaterStroke(p, p.mouseX, p.mouseY, true);
                            } else {
                                this.drawPaintStroke(p, p.mouseX, p.mouseY, true);
                            }
                        };

                        p.mouseReleased = () => {
                            this.isPainting = false;
                        };

                        p.windowResized = () => {
                            p.resizeCanvas(window.innerWidth, window.innerHeight);
                            p.background(248, 245, 242);
                        };
                    };
                    
                    new p5(sketch);
                },
                
                // –†–∏—Å–æ–≤–∞–Ω–∏–µ –∫—Ä–∞—Å–∫–æ–π
                drawPaintStroke(p, x, y, isStart = false) {
                    let color = p.color(this.selectedColor);
                    let r = p.red(color);
                    let g = p.green(color);
                    let b = p.blue(color);
                    
                    let size = isStart ? this.brushSize * 1.2 : this.brushSize;
                    let alpha = isStart ? this.transparency * 1.5 : this.transparency;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è —Ç–µ–∫—Å—Ç—É—Ä—ã –∫–∏—Å—Ç–∏
                    let offsetX = p.random(-size/8, size/8);
                    let offsetY = p.random(-size/8, size/8);
                    
                    // –û—Å–Ω–æ–≤–Ω–æ–π –º–∞–∑–æ–∫
                    p.push();
                    p.translate(x + offsetX, y + offsetY);
                    p.rotate(p.random(-0.1, 0.1));
                    
                    p.fill(r, g, b, alpha);
                    p.ellipse(0, 0, size * 0.8, size * 1.2);
                    
                    p.fill(r, g, b, alpha * 0.5);
                    p.ellipse(0, 0, size * 1.2, size * 1.5);
                    p.pop();
                    
                    // –≠—Ñ—Ñ–µ–∫—Ç —Ä–∞—Å—Ç–µ–∫–∞–Ω–∏—è
                    if (this.flow > 3 && p.random() > 0.5) {
                        let bleedCount = Math.floor(this.flow * 0.5);
                        for (let i = 0; i < bleedCount; i++) {
                            let bleedX = x + p.random(-size, size);
                            let bleedY = y + p.random(-size, size);
                            let bleedSize = size * p.random(0.1, 0.3);
                            let bleedAlpha = alpha * p.random(0.1, 0.3);
                            
                            p.fill(r, g, b, bleedAlpha);
                            p.ellipse(bleedX, bleedY, bleedSize);
                        }
                    }
                },
                
                // –†–∏—Å–æ–≤–∞–Ω–∏–µ –≤–æ–¥–æ–π
                drawWaterStroke(p, x, y, isStart = false) {
                    let size = isStart ? this.brushSize * 0.8 : this.brushSize * 0.7;
                    
                    p.fill(240, 245, 255, 15);
                    p.ellipse(x, y, size);
                    
                    // –≠—Ñ—Ñ–µ–∫—Ç —Ä–∞–∑–º—ã—Ç–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫—Ä–∞—Å–∫–∏
                    if (p.random() > 0.7) {
                        p.fill(240, 245, 255, 8);
                        p.ellipse(x + p.random(-10, 10), y + p.random(-10, 10), size * 1.5);
                    }
                },
                
                // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –≤–æ–¥–∞/–∫—Ä–∞—Å–∫–∞
                toggleWaterMode() {
                    this.waterMode = !this.waterMode;
                },
                
                // –û—á–∏—Å—Ç–∫–∞ —Ö–æ–ª—Å—Ç–∞
                clearCanvas() {
                    if (this.p5Canvas) {
                        this.p5Canvas.background(248, 245, 242);
                    }
                },
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ p5 (–∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è x-effect)
                updateP5Settings() {
                    // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                    // –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
                }
            }));
        });
    </script>
</body>
</html>