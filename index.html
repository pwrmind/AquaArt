<!DOCTYPE html>
<html lang="ru" x-data="watercolorApp">
<head>
    <meta charset="UTF-8">
    <title>Watercolor Flow Therapy - –ê–∫–≤–∞—Ä–µ–ª—å</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/2.0.5/p5.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #f8f5f2; font-family: sans-serif; }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä UI */
        #ui { 
            position: fixed; top: 20px; left: 20px; z-index: 100;
            display: flex; flex-direction: column; 
            /* gap: 15px;  */
            background: rgba(255, 255, 255, 0.98); padding: 15px; border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
            border: 1px solid rgba(0,0,0,0.05);
            user-select: none;
            transition: all 0.3s ease;
            min-width: 60px;
            /* max-width: 280px; */
        }
        
        /* –ü–∞–ª–∏—Ç—Ä–∞ - –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º–∞ */
        .palette { 
            display: flex; 
            gap: 8px; 
            flex-wrap: wrap;
            justify-content: center;
        }
        .dot { 
            width: 30px; 
            height: 30px; 
            border-radius: 50%; 
            cursor: pointer; 
            border: 2px solid #eee; 
            transition: 0.2s;
            flex-shrink: 0;
        }
        .dot.active { border-color: #333; transform: scale(1.1); }
        .dot:hover { transform: scale(1.05); }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫ - —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏ */
        .settings-container {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .settings-container.collapsed {
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
        }
        .settings-container.expanded {
            max-height: 400px;
            opacity: 1;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 1px solid rgba(0,0,0,0.08);
        }
        
        .slider-group { 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            font-size: 13px; 
            color: #555; 
            margin-bottom: 15px;
        }
        input[type=range] { 
            cursor: pointer; 
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: #eee;
            outline: none;
        }
        
        button { 
            border: none; 
            background: #5d8aa8; 
            color: white; 
            padding: 8px 12px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: 500; 
            transition: 0.2s;
            font-size: 13px;
            width: 100%;
            margin-bottom: 5px;
        }
        button:hover { background: #4a7795; }
        button.secondary { background: #e0e0e0; color: #333; }
        button.secondary:hover { background: #d0d0d0; }
        
        .title { 
            font-size: 12px; 
            font-weight: 600; 
            color: #333; 
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è */
        .collapse-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            font-size: 16px;
            color: #666;
            transition: 0.2s;
            width: auto;
            margin: 0;
        }
        .collapse-btn:hover {
            color: #333;
            background: none;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∑–Ω–∞—á–µ–Ω–∏–π */
        .value-display { 
            font-size: 11px; 
            color: #777; 
            display: flex; 
            justify-content: space-between;
            margin-top: 2px;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ö–æ–ª—Å—Ç–∞ */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ */
        .mode-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 11px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ —É–≥–ª—É –ø–∞–ª–∏—Ç—Ä—ã */
        .palette-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #5d8aa8;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —Å–ª–∞–π–¥–µ—Ä–æ–≤ */
        input[type=range]::-webkit-slider-thumb {
            background: #5d8aa8;
        }
    </style>
</head>
<body x-on:keydown.escape="clearCanvas()">
    <div id="ui" x-on:click.stop>
        <!-- –ü–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤ -->
        <div class="palette">
            <template x-for="color in colors" :key="color.value">
                <div 
                    class="dot" 
                    :class="{ active: selectedColor === color.value }"
                    :style="`background: ${color.value}`"
                    x-on:click="selectedColor = color.value"
                    :title="color.name"
                    style="position: relative;"
                >
                    <div 
                        class="palette-indicator" 
                        x-show="selectedColor === color.value"
                        :style="`background: ${color.value}`"
                    >
                        ‚úì
                    </div>
                </div>
            </template>
            <button class="collapse-btn" x-on:click="panelCollapsed = !panelCollapsed">
                <span x-text="panelCollapsed ? '‚ñº' : '‚ñ≤'"></span>
            </button>
        </div>
        
        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (—Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏) -->
        <div 
            class="settings-container" 
            :class="panelCollapsed ? 'collapsed' : 'expanded'"
        >
            <div class="slider-group">
                <div class="title">–†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏</div>
                <input 
                    type="range" 
                    x-model="brushSize"
                    min="8" 
                    max="50" 
                    step="1"
                    x-on:mousedown.stop
                    x-on:click.stop
                >
                <div class="value-display">
                    <span>–ú–∞–ª–µ–Ω—å–∫–∞—è</span>
                    <span x-text="brushSize + 'px'"></span>
                    <span>–ë–æ–ª—å—à–∞—è</span>
                </div>
            </div>

            <div class="slider-group">
                <div class="title">–†–∞–∑–±–∞–≤–ª–µ–Ω–∏–µ –≤–æ–¥–æ–π</div>
                <input 
                    type="range" 
                    x-model="waterAmount"
                    min="10" 
                    max="90" 
                    step="1"
                    x-on:mousedown.stop
                    x-on:click.stop
                >
                <div class="value-display">
                    <span>–ö–æ–Ω—Ü–µ–Ω—Ç—Ä.</span>
                    <span x-text="waterAmount + '%'"></span>
                    <span>–†–∞–∑–±–∞–≤–ª.</span>
                </div>
            </div>

            <div class="slider-group">
                <div class="title">–†–∞—Å—Ç–µ–∫–∞–Ω–∏–µ</div>
                <input 
                    type="range" 
                    x-model="flow"
                    min="1" 
                    max="10" 
                    step="1"
                    x-on:mousedown.stop
                    x-on:click.stop
                >
                <div class="value-display">
                    <span>–°—É—Ö–æ</span>
                    <span x-text="flow"></span>
                    <span>–ú–æ–∫—Ä–æ</span>
                </div>
            </div>

            <div style="display: flex; gap: 8px; margin-top: 10px;">
                <button x-on:click="clearCanvas()" class="secondary">–û—á–∏—Å—Ç–∏—Ç—å</button>
                <button x-on:click="toggleWaterMode()" 
                        :style="waterMode ? 'background: #a8d5e2; color: #333' : ''">
                    <span x-text="waterMode ? 'üí¶ –í–æ–¥–∞' : 'üé® –ö—Ä–∞—Å–∫–∞'"></span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ -->
    <div class="mode-indicator" x-show="!panelCollapsed">
        <span x-text="waterMode ? 'üí¶ –†–µ–∂–∏–º –≤–æ–¥—ã' : 'üé® –†–µ–∂–∏–º –∫—Ä–∞—Å–∫–∏'"></span>
    </div>

    <div id="canvas-container"></div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('watercolorApp', () => ({
                // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                colors: [
                    { name: '–ì–æ–ª—É–±–æ–π', value: '#5d8aa8' },
                    { name: '–†–æ–∑–æ–≤—ã–π', value: '#e3a6a1' },
                    { name: '–ó–µ–ª–µ–Ω—ã–π', value: '#7da67d' },
                    { name: '–ñ–µ–ª—Ç—ã–π', value: '#f4d35e' },
                    { name: '–§–∏–æ–ª–µ—Ç–æ–≤—ã–π', value: '#9a7bc9' },
                    { name: '–ö–æ—Ä–∏—á–Ω–µ–≤—ã–π', value: '#8B4513' },
                    { name: '–ë–∏—Ä—é–∑–æ–≤—ã–π', value: '#40E0D0' },
                    { name: '–ö–æ—Ä–∞–ª–ª–æ–≤—ã–π', value: '#FF7F50' }
                ],
                
                // –†–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                selectedColor: '#5d8aa8',
                brushSize: 25,
                waterAmount: 70, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∏–ª—å–Ω–æ —Ä–∞–∑–±–∞–≤–ª–µ–Ω–Ω–∞—è –∫—Ä–∞—Å–∫–∞
                flow: 4,
                waterMode: false,
                panelCollapsed: false, // –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–≤–µ—Ä–Ω—É—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                
                // p5.js –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                p5Canvas: null,
                isPainting: false,
                lastMouseX: 0,
                lastMouseY: 0,
                paintDensity: 0, // –ü–ª–æ—Ç–Ω–æ—Å—Ç—å –∫—Ä–∞—Å–∫–∏ –Ω–∞ —Ö–æ–ª—Å—Ç–µ –≤ –¥–∞–Ω–Ω–æ–π —Ç–æ—á–∫–µ
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                init() {
                    this.$nextTick(() => {
                        this.setupP5();
                        document.addEventListener('contextmenu', e => e.preventDefault());
                    });
                },
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ p5.js
                setupP5() {
                    const sketch = (p) => {
                        p.setup = () => {
                            this.p5Canvas = p.createCanvas(window.innerWidth, window.innerHeight);
                            this.p5Canvas.parent('canvas-container');
                            p.background(248, 245, 242);
                            p.noStroke();
                        };

                        p.draw = () => {
                            // –ú–µ–¥–ª–µ–Ω–Ω–æ–µ –≤—ã—Å—ã—Ö–∞–Ω–∏–µ - –æ—á–µ–Ω—å –ª–µ–≥–∫–æ–µ
                            if (p.frameCount % 5 === 0) {
                                let img = p.get();
                                p.tint(255, 255, 255, 255);
                                p.background(248, 245, 242, 1); // –û—á–µ–Ω—å –ª–µ–≥–∫–æ–µ –≤—ã—Å—ã—Ö–∞–Ω–∏–µ
                                p.image(img, 0, 0);
                            }
                            
                            // –†–∏—Å–æ–≤–∞–Ω–∏–µ
                            if (this.isPainting) {
                                let distance = p.dist(p.mouseX, p.mouseY, this.lastMouseX, this.lastMouseY);
                                
                                // –î–ª—è –∞–∫–≤–∞—Ä–µ–ª–∏ - –º–µ–Ω—å—à–µ —Ç–æ—á–µ–∫ –ø—Ä–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏–∏
                                if (distance > 3) {
                                    let steps = Math.max(1, Math.floor(distance / 4)); // –£–≤–µ–ª–∏—á–∏–ª–∏ —à–∞–≥
                                    
                                    for (let i = 0; i <= steps; i++) {
                                        let interp = i / steps;
                                        let x = p.lerp(this.lastMouseX, p.mouseX, interp);
                                        let y = p.lerp(this.lastMouseY, p.mouseY, interp);
                                        
                                        if (this.waterMode) {
                                            this.drawWaterStroke(p, x, y);
                                        } else {
                                            this.drawPaintStroke(p, x, y);
                                        }
                                    }
                                    
                                    this.lastMouseX = p.mouseX;
                                    this.lastMouseY = p.mouseY;
                                }
                            }
                        };

                        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –º—ã—à–∏
                        p.mousePressed = () => {
                            let ui = document.getElementById('ui');
                            let rect = ui.getBoundingClientRect();
                            
                            if (p.mouseX >= rect.left && p.mouseX <= rect.right &&
                                p.mouseY >= rect.top && p.mouseY <= rect.bottom) {
                                return;
                            }
                            
                            this.isPainting = true;
                            this.lastMouseX = p.mouseX;
                            this.lastMouseY = p.mouseY;
                        };

                        p.mouseReleased = () => {
                            this.isPainting = false;
                        };

                        p.windowResized = () => {
                            p.resizeCanvas(window.innerWidth, window.innerHeight);
                            p.background(248, 245, 242);
                        };
                    };
                    
                    new p5(sketch);
                },
                
                // –†–∏—Å–æ–≤–∞–Ω–∏–µ –∞–∫–≤–∞—Ä–µ–ª—å–Ω–æ–π –∫—Ä–∞—Å–∫–æ–π
                drawPaintStroke(p, x, y) {
                    let color = p.color(this.selectedColor);
                    let r = p.red(color);
                    let g = p.green(color);
                    let b = p.blue(color);
                    
                    // –†–∞—Å—á–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–±–∞–≤–ª–µ–Ω–∏—è –≤–æ–¥–æ–π
                    // –ß–µ–º –±–æ–ª—å—à–µ –≤–æ–¥—ã, —Ç–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ –∫—Ä–∞—Å–∫–∞
                    let baseAlpha = p.map(this.waterAmount, 10, 90, 80, 15);
                    
                    // –†–∞–∑–º–µ—Ä –∫–∏—Å—Ç–∏ —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏ –¥–ª—è –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–æ—Å—Ç–∏
                    let sizeVariation = p.random(-0.1, 0.1);
                    let currentSize = this.brushSize * (1 + sizeVariation);
                    
                    // –°–ª—É—á–∞–π–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Ç–µ–∫—Å—Ç—É—Ä—ã –∫–∏—Å—Ç–∏
                    let offsetX = p.random(-currentSize/10, currentSize/10);
                    let offsetY = p.random(-currentSize/10, currentSize/10);
                    
                    // –û—Å–Ω–æ–≤–Ω–æ–π –º–∞–∑–æ–∫ - –æ—á–µ–Ω—å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –¥–ª—è –∞–∫–≤–∞—Ä–µ–ª–∏
                    p.push();
                    p.translate(x + offsetX, y + offsetY);
                    
                    // –õ–µ–≥–∫–æ–µ –∏—Å–∫–∞–∂–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –∫–∏—Å—Ç–∏
                    let rotation = p.random(-0.05, 0.05);
                    p.rotate(rotation);
                    
                    // –Ø–¥—Ä–æ –º–∞–∑–∫–∞ (–æ—á–µ–Ω—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–µ)
                    p.fill(r, g, b, baseAlpha * 0.3);
                    p.ellipse(0, 0, currentSize * 0.7, currentSize * 1.1);
                    
                    // –õ–µ–≥–∫–∏–π –æ—Ä–µ–æ–ª (–µ—â–µ –±–æ–ª–µ–µ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π)
                    p.fill(r, g, b, baseAlpha * 0.15);
                    p.ellipse(0, 0, currentSize * 1.2, currentSize * 1.5);
                    p.pop();
                    
                    // –≠—Ñ—Ñ–µ–∫—Ç —Ä–∞—Å—Ç–µ–∫–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å—Ä–µ–¥–Ω–µ–º –∏ –≤—ã—Å–æ–∫–æ–º flow)
                    if (this.flow > 3 && p.random() > 0.6) {
                        let bleedCount = Math.floor(this.flow * 0.3); // –ú–µ–Ω—å—à–µ –∫–∞–ø–µ–ª—å
                        
                        for (let i = 0; i < bleedCount; i++) {
                            // –ö–∞–ø–ª–∏ —Ä–∞—Å—Ç–µ–∫–∞—é—Ç—Å—è –¥–∞–ª—å—à–µ –ø—Ä–∏ –±–æ–ª—å—à–µ–º flow
                            let bleedDistance = p.map(this.flow, 1, 10, 5, 20);
                            let angle = p.random(p.TWO_PI);
                            let bleedX = x + p.cos(angle) * bleedDistance;
                            let bleedY = y + p.sin(angle) * bleedDistance;
                            
                            let bleedSize = currentSize * p.random(0.05, 0.15);
                            let bleedAlpha = baseAlpha * p.random(0.05, 0.1);
                            
                            p.fill(r, g, b, bleedAlpha);
                            p.ellipse(bleedX, bleedY, bleedSize);
                            
                            // –û—á–µ–Ω—å –ª–µ–≥–∫–∏–π —Å–ª–µ–¥ –æ—Ç —Ä–∞—Å—Ç–µ–∫–∞–Ω–∏—è
                            if (p.random() > 0.7) {
                                p.fill(r, g, b, bleedAlpha * 0.3);
                                p.ellipse(
                                    x + p.cos(angle) * bleedDistance * 0.5,
                                    y + p.sin(angle) * bleedDistance * 0.5,
                                    bleedSize * 0.7
                                );
                            }
                        }
                    }
                    
                    // –û—á–µ–Ω—å —Ä–µ–¥–∫–∏–µ —Å–ª—É—á–∞–π–Ω—ã–µ –∫–∞–ø–ª–∏ (–∫–∞–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∞–∫–≤–∞—Ä–µ–ª–∏)
                    if (p.random() > 0.95) {
                        let dropX = x + p.random(-currentSize, currentSize);
                        let dropY = y + p.random(-currentSize, currentSize);
                        let dropSize = currentSize * p.random(0.02, 0.08);
                        
                        p.fill(r, g, b, baseAlpha * 0.2);
                        p.ellipse(dropX, dropY, dropSize);
                    }
                },
                
                // –†–∏—Å–æ–≤–∞–Ω–∏–µ –≤–æ–¥–æ–π
                drawWaterStroke(p, x, y) {
                    let size = this.brushSize * 0.8;
                    
                    // –í–æ–¥–∞ –ø–æ—á—Ç–∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è
                    p.fill(200, 220, 240, 8);
                    p.ellipse(x, y, size);
                    
                    // –õ–µ–≥–∫–∏–π —ç—Ñ—Ñ–µ–∫—Ç —Ä–∞–∑–º—ã—Ç–∏—è
                    if (p.random() > 0.8) {
                        p.fill(200, 220, 240, 5);
                        p.ellipse(x + p.random(-10, 10), y + p.random(-10, 10), size * 1.3);
                    }
                },
                
                // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –≤–æ–¥–∞/–∫—Ä–∞—Å–∫–∞
                toggleWaterMode() {
                    this.waterMode = !this.waterMode;
                },
                
                // –û—á–∏—Å—Ç–∫–∞ —Ö–æ–ª—Å—Ç–∞
                clearCanvas() {
                    if (this.p5Canvas) {
                        this.p5Canvas.background(248, 245, 242);
                    }
                }
            }));
        });
    </script>
</body>
</html>