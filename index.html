<!DOCTYPE html>
<html>
<head>
    <title>Watercolor Diffusion Therapy</title>
    <style>
        body { margin: 0; overflow: hidden; background: #fff; cursor: crosshair; }
        #ui { position: fixed; top: 20px; left: 20px; z-index: 10; display: flex; gap: 12px; background: #fff; padding: 10px 20px; border-radius: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); align-items: center; }
        .palette { display: flex; gap: 8px; }
        .color { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid #f0f0f0; }
        .active { border-color: #000; transform: scale(1.1); }
        canvas { position: absolute; top: 0; left: 0; }
    </style>
</head>
<body>

<div id="ui">
    <div class="palette" id="palette">
        <div class="color active" style="background: #4A90E2" data-color="#4A90E2"></div>
        <div class="color" style="background: #E36397" data-color="#E36397"></div>
        <div class="color" style="background: #91BA5D" data-color="#91BA5D"></div>
        <div class="color" style="background: #F5A623" data-color="#F5A623"></div>
    </div>
    <button onclick="clearCanvas()" style="border:none; background:none; color:#999; cursor:pointer;">Сброс</button>
</div>

<canvas id="canvas"></canvas>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    let isDrawing = false;
    let currentColor = "#4A90E2";
    
    // Настройки диффузии
    const diffusionRate = 1.5; // Скорость растекания
    const opacity = 0.04;    // Прозрачность пигмента

    function init() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function hexToRgb(hex) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `${r},${g},${b}`;
    }

    function spread() {
        if (!isDrawing) return;
        
        // Магия диффузии: создаем мягкое "расползание" через фильтр на лету
        // Мы слегка размываем весь холст и накладываем его на самого себя
        ctx.save();
        ctx.globalAlpha = 0.05; // Коэффициент текучести
        ctx.filter = `blur(${diffusionRate}px)`;
        ctx.drawImage(canvas, 0, 0);
        ctx.restore();
    }

    function draw(x, y) {
        const size = 25;
        const rgb = hexToRgb(currentColor);
        
        // Рисуем "ядро" пигмента
        for(let i = 0; i < 3; i++) {
            ctx.beginPath();
            const rx = x + (Math.random() - 0.5) * size;
            const ry = y + (Math.random() - 0.5) * size;
            ctx.arc(rx, ry, Math.random() * size, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(${rgb}, ${opacity})`;
            ctx.fill();
        }
        
        spread(); // Запускаем диффузию при движении
    }

    canvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        draw(e.clientX, e.clientY);
    });

    window.addEventListener('mousemove', (e) => {
        if (isDrawing) draw(e.clientX, e.clientY);
    });

    window.addEventListener('mouseup', () => isDrawing = false);

    document.getElementById('palette').onclick = (e) => {
        if (e.target.classList.contains('color')) {
            document.querySelector('.active').classList.remove('active');
            e.target.classList.add('active');
            currentColor = e.target.dataset.color;
        }
    };

    function clearCanvas() {
        ctx.filter = 'none';
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    init();
    // Постоянная микро-диффузия для "живого" холста
    setInterval(() => { if(isDrawing) spread(); }, 50);
</script>
</body>
</html>
